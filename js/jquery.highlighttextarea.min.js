!function(t){"use strict";var i=function(t){return!isNaN(parseFloat(t))&&isFinite(t)},e=function(i,n){this.settings=t.extend({},e.DEFAULTS),this.scrollbarWidth=s.getScrollbarWidth(),this.isInput="input"==i[0].tagName.toLowerCase(),this.active=!1,this.matches=[],this.$el=i,this.$el.wrap('<div class="highlightTextarea"></div>'),this.$main=this.$el.parent(),this.$main.prepend('<div class="highlightTextarea-container"><div class="highlightTextarea-highlighter"></div></div>'),this.$container=this.$main.children().first(),this.$highlighter=this.$container.children(),this.setOptions(n),this.settings.id&&(this.$main[0].id=this.settings.id),this.settings.resizable&&this.applyResizable(),this.updateCss(),this.bindEvents(),this.highlight()};e.DEFAULTS={words:{},ranges:{},color:"#ffff00",caseSensitive:!0,wordsOnly:!1,resizable:!1,resizableOptions:{},id:"",debug:!1},e.prototype.highlight=function(){var i=this.$el.val(),e=this;e.spacer="",this.settings.wordsOnly&&(e.spacer="\\b");var n=[];if(t.each(this.settings.words,function(s,r){var h=new RegExp(e.spacer+"("+r.join("|")+")"+e.spacer,e.regParam),a=i.match(h);if(a){var o=[];t.each(a,function(t,e){n.push(e),-1===o.indexOf(e)&&(i=i.replace(new RegExp(e,"g"),'<mark style="background-color:'+s+';">$&</mark>',"g"),o.push(e))})}}),t.each(this.settings.ranges,function(t,e){if(e.start<i.length){i=s.strInsert(i,e.end,"</mark>");var n='<mark style="background-color:'+e.color+';"';null!=e["class"]&&(n+='class="'+e["class"]+'"'),n+=">",i=s.strInsert(i,e.start,n)}}),n.length!==this.matches.length){this.matches=n;var r=t.Event("matchesChanged");r.matches=this.matches,this.$el.trigger(r)}this.$highlighter.html(i),this.updateSizePosition()},e.prototype.setWords=function(t){this.setOptions({words:t,ranges:{}})},e.prototype.setRanges=function(t){this.setOptions({words:{},ranges:t})},e.prototype.enable=function(){this.bindEvents(),this.highlight()},e.prototype.disable=function(){this.unbindEvents(),this.$highlighter.empty()},e.prototype.destroy=function(){this.disable(),s.cloneCss(this.$container,this.$el,["background-image","background-color","background-position","background-repeat","background-origin","background-clip","background-size","background-attachment"]),this.$main.replaceWith(this.$el),this.$el.removeData("highlighter")},e.prototype.setOptions=function(i){"object"!=typeof i||t.isEmptyObject(i)||(t.extend(this.settings,i),this.regParam=this.settings.caseSensitive?"gm":"gim",t.isEmptyObject(this.settings.words)?t.isEmptyObject(this.settings.ranges)||(this.settings.words={},this.settings.ranges=s.cleanRanges(this.settings.ranges,this.settings.color)):(this.settings.words=s.cleanWords(this.settings.words,this.settings.color),this.settings.ranges={}),this.settings.debug?this.$main.addClass("debug"):this.$main.removeClass("debug"),this.active&&this.highlight())},e.prototype.bindEvents=function(){if(!this.active){this.active=!0;var i=this;this.$highlighter.bind({"this.highlighter":function(){i.$el.focus()}}),this.$el.bind({"input.highlightTextarea":s.throttle(function(){this.highlight()},100,this),"resize.highlightTextarea":s.throttle(function(){this.updateSizePosition(!0)},50,this),"scroll.highlightTextarea select.highlightTextarea":s.throttle(function(){this.updateSizePosition()},50,this)}),this.isInput&&this.$el.bind({"keydown.highlightTextarea keypress.highlightTextarea keyup.highlightTextarea":function(){setTimeout(t.proxy(i.updateSizePosition,i),1)},"blur.highlightTextarea":function(){this.value=this.value,this.scrollLeft=0,i.updateSizePosition.call(i)}})}},e.prototype.unbindEvents=function(){this.active&&(this.active=!1,this.$highlighter.off(".highlightTextarea"),this.$el.off(".highlightTextarea"))},e.prototype.updateCss=function(){s.cloneCss(this.$el,this.$main,["float","vertical-align"]),this.$main.css({width:this.$el.outerWidth(!0),height:this.$el.outerHeight(!0)}),s.cloneCss(this.$el,this.$container,["background-image","background-color","background-position","background-repeat","background-origin","background-clip","background-size","background-attachment","padding-top","padding-right","padding-bottom","padding-left"]),this.$container.css({top:s.toPx(this.$el.css("margin-top"))+s.toPx(this.$el.css("border-top-width")),left:s.toPx(this.$el.css("margin-left"))+s.toPx(this.$el.css("border-left-width")),width:this.$el.width(),height:this.$el.height()}),s.cloneCss(this.$el,this.$highlighter,["font-size","font-family","font-style","font-weight","font-variant","font-stretch","vertical-align","word-spacing","text-align","letter-spacing","text-rendering"]),this.$el.css({background:"none"})},e.prototype.applyResizable=function(){if(jQuery.ui){var i={handles:"se",resize:s.throttle(function(){this.updateSizePosition(!0)},50,this)},e=t.extend({},i,this.settings.resizableOptions);this.$el.resizable(e)}},e.prototype.updateSizePosition=function(t){t&&(this.$main.css({width:this.$el.outerWidth(!0),height:this.$el.outerHeight(!0)}),this.$container.css({width:this.$el.width(),height:this.$el.height()}));var i,e=0;this.isInput?i=99999:(("scroll"==this.$el.css("overflow")||"scroll"==this.$el.css("overflow-y")||"hidden"!=this.$el.css("overflow")&&"hidden"!=this.$el.css("overflow-y")&&this.$el[0].clientHeight<this.$el[0].scrollHeight)&&(e=this.scrollbarWidth),i=this.$el.width()-e),this.$highlighter.css({width:i,height:this.$el.height()+this.$el.scrollTop(),top:-this.$el.scrollTop(),left:-this.$el.scrollLeft()})};var s=function(){};s.getScrollbarWidth=function(){var i=t('<div style="width:50px;height:50px;overflow:auto"><div>&nbsp;</div></div>').appendTo("body"),e=i.children(),s=e.innerWidth()-e.height(100).innerWidth();return i.remove(),s},s.cloneCss=function(t,i,e){for(var s=0,n=e.length;n>s;s++)i.css(e[s],t.css(e[s]))},s.toPx=function(i){if(i!=i.replace("em","")){var e=t('<div style="font-size:1em;margin:0;padding:0;height:auto;line-height:1;border:0;">&nbsp;</div>').appendTo("body");return i=Math.round(parseFloat(i.replace("em",""))*e.height()),e.remove(),i}return i!=i.replace("px","")?parseInt(i.replace("px","")):parseInt(i)},s.htmlEntities=function(i){return i?t("<div></div>").text(i).html():""},s.strInsert=function(t,i,e){return t.slice(0,i)+e+t.slice(i)},s.throttle=function(t,i,e){var s={pid:null,last:0};return function(){function n(){return s.last=(new Date).getTime(),e?t.apply(e,Array.prototype.slice.call(h)):t.apply(a,Array.prototype.slice.call(h))}var r=(new Date).getTime()-s.last,h=arguments,a=this;return r>i?n():(clearTimeout(s.pid),void(s.pid=setTimeout(n,i-r)))}},s.cleanWords=function(i,e){var n={};t.isArray(i)||(i=[i]);for(var r=0,h=i.length;h>r;r++){var a=i[r];if(t.isPlainObject(a)){n[a.color]||(n[a.color]=[]),t.isArray(a.words)||(a.words=[a.words]);for(var o=0,l=a.words.length;l>o;o++)n[a.color].push(s.htmlEntities(a.words[o]))}else n[e]||(n[e]=[]),n[e].push(s.htmlEntities(a))}return n},s.cleanRanges=function(e,s){var n=[];(t.isPlainObject(e)||i(e[0]))&&(e=[e]);for(var r=0,h=e.length;h>r;r++){var a=e[r];if(t.isArray(a))n.push({color:s,start:a[0],end:a[1]});else if(a.ranges){(t.isPlainObject(a.ranges)||i(a.ranges[0]))&&(a.ranges=[a.ranges]);for(var o=0,l=a.ranges.length;l>o;o++)t.isArray(a.ranges[o])?n.push({color:a.color,"class":a["class"],start:a.ranges[o][0],end:a.ranges[o][1]}):(a.ranges[o].length&&(a.ranges[o].end=a.ranges[o].start+a.ranges[o].length),n.push(a.ranges[o]))}else a.length&&(a.end=a.start+a.length),n.push(a)}n.sort(function(t,i){return t.start==i.start?t.end-i.end:t.start-i.start});var g=-1;return t.each(n,function(i,e){e.start>=e.end&&t.error("Invalid range end/start"),e.start<g&&t.error("Ranges overlap"),g=e.end}),n.reverse(),n},t.fn.highlightTextarea=function(i){var s=arguments;return this.each(function(){var n=t(this),r=n.data("highlighter"),h="object"==typeof i&&i;(r||"destroy"!=i)&&(r||(r=new e(n,h),n.data("highlighter",r)),"string"==typeof i&&r[i].apply(r,Array.prototype.slice.call(s,1)))})}}(window.jQuery||window.Zepto);